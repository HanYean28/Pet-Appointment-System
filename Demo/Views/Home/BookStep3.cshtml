@using Microsoft.IdentityModel.Tokens
@using System.Security.Claims;
@model PawfectGrooming.Models.Booking
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<PawfectGrooming.Resources.Resources> Localizer
@using System.Globalization
@{
    ViewBag.Title = "Confirm Appointment";
    var step = 3;
}

<section class="booking-section">
    <h1 class="section-title">Confirm Your Appointment</h1>
    <div class="booking-card">
        @Html.Partial("_BookingSteps", step)

        <form id="confirmForm" asp-action="BookStep3" method="post">
            @Html.AntiForgeryToken()

            <!-- Hidden fields to pass data -->
            <input type="hidden" name="Id" value="@Model.Id" />
            <input type="hidden" name="Date" value="@Model.Date.ToString("yyyy-MM-dd")" />
            <input type="hidden" name="Time" value="@Model.Time" />
            <input type="hidden" name="PetId" value="@Model.Pet?.PetId" />
            <input type="hidden" name="PetName" value="@Model.Pet?.Name" />
            <input type="hidden" name="PetType" value="@Model.Pet?.PetType" />
            <input type="hidden" name="PetBreed" value="@Model.Pet?.Breed" />
            <input type="hidden" name="PetWeight" value="@Model.Pet?.Weight" />
            <input type="hidden" name="SpecialInstructions" value="@Model.Pet?.MedicalNotes" />
            <input type="hidden" name="OwnerName" value="@Model.User?.Name" />
            <input type="hidden" name="OwnerPhone" value="@Model.User?.PhoneNumber" />
            <input type="hidden" name="appointmentId" value="@(Model.Id != 0 ? Model.Id : ViewBag.AppointmentId)" />
            <input type="hidden" name="ServiceId" value="@(Model.Service?.Id ?? 0)" />
            <input type="hidden" name="PackageId" value="@(Model.Package?.Id ?? 0)" />
            <input type="hidden" name="Service" value="@Model.Service?.Name"/>
            <input type="hidden" name="Package" value="@Model.Package?.Name" />
            <input type="hidden" name="Price" value="@Model.Price" />

            <div class="confirm-details-box">
                <h2 class="confirm-section-title">Appointment Details</h2>
                <div class="confirm-details-grid">
                    <!-- Package or Service -->
                    @if (Model.Id != 0)
                    {
                        <input type="hidden" name="appointmentId" value="@Model.Id" />
                    }

                    @if (Model.Service != null)
                    {
                        <div>
                            <p class="confirm-label">@Localizer["Service"]:</p>
                            <p class="confirm-value">@Localizer[@Model.Service.Name]</p>
                        </div>
                        <div>
                            <p class="confirm-label">@Localizer["Service"] @Localizer["Price"]:</p>
                            <p class="confirm-value">RM @Model.Service.Price</p>
                        </div>
                    }

                    @if (Model.Package != null)
                    {
                        <div>
                            <p class="confirm-label">@Localizer["Package"]:</p>
                            <p class="confirm-value">@Localizer[@Model.Package.Name]</p>
                        </div>
                        <div>
                            <p class="confirm-label">@Localizer["Package"] @Localizer["Price"]:</p>
                            <p class="confirm-value">RM @Model.Package.Price</p>
                        </div>
                    }

                    <div>
                        <p class="confirm-label">@Localizer["Date"]:</p>
                        <p class="confirm-value">@Model.Date.ToString("dddd, MMMM dd, yyyy")</p>
                    </div>
                    <div>
                        <p class="confirm-label">@Localizer["Time"]:</p>
                        <p class="confirm-value">@Model.Time</p>
                    </div>
                </div>
            </div>

            <div class="confirm-info-row">
                <div class="confirm-info-box">
                    <h2 class="confirm-section-title">@Localizer["Pet Info"]</h2>
                    <p><span class="confirm-info-label">@Localizer["Name"]:</span> @Model.Pet?.Name</p>
                    <p><span class="confirm-info-label">@Localizer["Pet Type"]:</span> @Localizer[@Model.Pet?.PetType]</p>
                    <p><span class="confirm-info-label">@Localizer["Breed"]:</span> @Model.Pet?.Breed</p>
                    <p><span class="confirm-info-label">@Localizer["Weight"]:</span> @Model.Pet?.Weight kg</p>
                    <p><span class="confirm-info-label">@Localizer["Medical Notes"]:</span> @(string.IsNullOrWhiteSpace(Model.Pet?.MedicalNotes) ? "None" : Model.Pet.MedicalNotes)</p>
                </div>
                <div class="confirm-info-box">
                    <h2 class="confirm-section-title">@Localizer["Owner Information"]</h2>
                    <p><span class="confirm-info-label">@Localizer["Name"]:</span> @Model.User?.Name</p>
                    <p><span class="confirm-info-label">@Localizer["Phone Number"]:</span> @Model.User?.PhoneNumber</p>
                    <p><span class="confirm-info-label">@Localizer["Email"]:</span> @Model.User?.Email</p>
                </div>
            </div>

            <div class="booking-actions">
                <a href="@Url.Action("Book", "Home", new { appointmentId = (Model.Id != 0 ? Model.Id : ViewBag.AppointmentId), step = 2 })"
                   class="btn btn-prev">@Localizer["Previous"]</a>
                <button type="submit" id="confirmBtn" class="btn btn-confirm">@Localizer["Confirm Appointment"]</button>
            </div>
        </form>
        <!-- Confirmation Modal -->
        <div id="confirmationModal" class="modal-overlay" style="display:none;">
            <div class="modal-content">
                <div class="modal-icon">
                    <svg width="56" height="56" fill="none" viewBox="0 0 56 56">
                        <circle cx="28" cy="28" r="28" fill="#D1FADF" />
                        <path d="M39 22.5L25.75 35.75L17 27" stroke="#22C55E" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h2 class="modal-title">@Localizer["Appointment Confirmed"]!</h2>
                <p class="modal-desc">@Localizer["Your pet grooming appointment has been successfully scheduled."]</p>
                <a href="@Url.Action("AppointmentsList", "Home")" class="btn btn-modal">@Localizer["View My Appointments"]</a>
            </div>
        </div>
    </div>
</section>