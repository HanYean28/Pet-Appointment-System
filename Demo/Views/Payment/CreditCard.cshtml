@model PawfectGrooming.Models.Payment
@{
    ViewData["Title"] = "Credit Card Payment";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var baseAmount = (decimal)(ViewBag.BaseAmount ?? 0m);
    var discount = (decimal)(ViewBag.Discount ?? 0m);
    var payable = (decimal)(ViewBag.PayableNow ?? 0m);
}

<div class="card-payment-container">
    <div class="card-payment-box">
        <h2 class="title">Credit Card Payment</h2>
        <p class="subtitle">Pay securely with your credit or debit card</p>

        <!-- Payment Summary -->
        <div class="payment-summary-box">
            <h3>Payment Summary</h3>
            <p><strong>Booking ID:</strong> @Model.BookingId</p>
            <p><strong>Payment Type:</strong> @Model.PaymentType</p>

            @if (string.Equals(Model.PaymentType, "Deposit", StringComparison.OrdinalIgnoreCase))
            {
                <p><strong>Amount:</strong> <span class="amount">RM 20.00</span></p>
            }
            else
            {
                <p><strong>Base:</strong> RM @baseAmount.ToString("0.00")</p>
                <p><strong>Discount:</strong> - RM @discount.ToString("0.00")</p>
                <hr />
                <p><strong>Amount:</strong> <span class="amount">RM @payable.ToString("0.00")</span></p>
            }
        </div>

        <!-- Payment Form -->
        @using (Html.BeginForm("Create", "Payment", FormMethod.Post, new { @class = "credit-form" }))
        {
            @Html.AntiForgeryToken()
            @Html.HiddenFor(m => m.BookingId)
            @Html.HiddenFor(m => m.PaymentMethod) <!-- Model has "Credit Card" from controller -->
            @Html.HiddenFor(m => m.PaymentType)

            <div class="form-group">
                @Html.LabelFor(m => m.CardNumber, new { @class = "form-label" })
                @Html.TextBoxFor(m => m.CardNumber, new {
                    @class = "form-control",
                    placeholder = "1234 5678 9012 3456",
                    maxlength = "19",
                    required = "required",
                    id = "cardNumber",
                    autocomplete = "off"
                })
                @Html.ValidationMessageFor(m => m.CardNumber, "", new { @class = "validation-error" })
            </div>

            <div class="form-row">
                <div class="form-group half">
                    @Html.LabelFor(m => m.ExpiryDate, new { @class = "form-label" })
                    @Html.TextBoxFor(m => m.ExpiryDate, new {
                        @class = "form-control",
                        placeholder = "MM/YY",
                        maxlength = "5",
                        required = "required",
                        id = "expiryDate",
                        autocomplete = "off"
                    })
                    @Html.ValidationMessageFor(m => m.ExpiryDate, "", new { @class = "validation-error" })
                </div>
                <div class="form-group half">
                    @Html.LabelFor(m => m.CVV, new { @class = "form-label" })
                    @Html.PasswordFor(m => m.CVV, new {
                        @class = "form-control",
                        placeholder = "123",
                        maxlength = "3",
                        required = "required",
                        id = "cvv",
                        autocomplete = "off"
                    })
                    @Html.ValidationMessageFor(m => m.CVV, "", new { @class = "validation-error" })
                </div>
            </div>

            <div class="payment-actions">
                <a href="@Url.Action("Create", new { bookingId = Model.BookingId, paymentType = Model.PaymentType })" class="btn btn-secondary">Back</a>
                <button type="submit" class="btn btn-primary">Pay Now</button>
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Card Number: auto-spacing + validation
        document.getElementById("cardNumber").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length > 16) value = value.substring(0, 16);
            e.target.value = value.match(/.{1,4}/g)?.join(" ") || value;
        });

        // Expiry Date: auto add slash + validation
        document.getElementById("expiryDate").addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length >= 3) value = value.substring(0, 2) + "/" + value.substring(2, 4);
            if (value.length > 5) value = value.substring(0, 5);
            e.target.value = value;
        });

        // CVV: only digits, max 3
        document.getElementById("cvv").addEventListener("input", function (e) {
            e.target.value = e.target.value.replace(/\D/g, "").substring(0, 3);
        });

        // On submit, validate before sending
        document.querySelector("form").addEventListener("submit", function (e) {
            let cardNum = document.getElementById("cardNumber").value.replace(/\s/g, "");
            let expiry = document.getElementById("expiryDate").value;
            let cvv = document.getElementById("cvv").value;

            if (cardNum.length !== 16) { alert("Card number must be 16 digits."); e.preventDefault(); return; }
            if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry)) { alert("Expiry date must be MM/YY."); e.preventDefault(); return; }
            if (cvv.length !== 3) { alert("CVV must be 3 digits."); e.preventDefault(); }
        });
    </script>
}

<style>
    .card-payment-container {
        display: flex;
        justify-content: center;
        padding: 40px;
        font-family: 'Inter', sans-serif;
    }

    .card-payment-box {
        background: #fff;
        padding: 32px;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        box-shadow: 0 16px 32px rgba(0,0,0,0.1);
    }

    .title {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .subtitle {
        text-align: center;
        color: #6b7280;
        margin-bottom: 20px;
    }

    .payment-summary-box {
        background: linear-gradient(135deg,#f0fdf4,#dcfce7);
        border: 1px solid #bbf7d0;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: center;
    }

    .amount {
        font-weight: 700;
        font-size: 20px;
        color: #10b981;
    }

    .form-group {
        margin-bottom: 16px;
    }

    .form-row {
        display: flex;
        gap: 16px;
    }

        .form-row .half {
            flex: 1;
        }

    .form-label {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 6px;
        display: block;
    }

    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
    }

    .validation-error {
        color: #dc2626;
        font-size: 13px;
    }

    .payment-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 20px;
    }

    .btn-primary {
        background: linear-gradient(135deg,#4f46e5,#6366f1);
        color: #fff;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
        transition: all .3s;
    }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 14px rgba(79,70,229,0.4);
        }

    .btn-secondary {
        background: #e5e7eb;
        color: #374151;
        border: none;
        padding: 12px 24px;
        border-radius: 10px;
        font-weight: 600;
    }
</style>
