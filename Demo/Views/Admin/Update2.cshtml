@model PawfectGrooming.Models.Package
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<PawfectGrooming.Resources.Resources> Localizer

@{
    ViewBag.Title = "Package Maintenance | Update Package";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string ResolveImage(string img)
    {
        if (string.IsNullOrWhiteSpace(img)) return Url.Content("~/images/noimage.png");
        if (img.StartsWith("http", StringComparison.OrdinalIgnoreCase) || img.StartsWith("/")) return img;
        return Url.Content($"~/images/Service_Images/{img}");
    }
    var firstImage = (Model?.ImageURL != null && Model.ImageURL.Any()) ? Model.ImageURL.FirstOrDefault() : null;
    var previewSrc = ResolveImage(firstImage);
    var previewText = string.IsNullOrWhiteSpace(firstImage) ? Localizer["Select Photo"] + "..." : firstImage;
}

<form asp-action="Update2" method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <table class="table">
        <h1 class="section-title">Update Package</h1>
        <p class="form-description">
            Please update package information below.
        </p>

        @* Add this near the top of the form (right after the page heading) to show debug info
        @if (TempData["DebugFiles"] != null)
        {
            <div class="alert alert-info" role="status" style="margin-bottom:1rem;">
                @TempData["DebugFiles"]
            </div>
        } *@

        @* Preserve Id and existing ImageURL so the form shows DB values on first render and retains them on postback *@
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="ImageURL" />
        <div class="form-group">
            <label asp-for="Id"></label>
            <b>@Model.Id</b>
        </div>

        <div class="form-group">
            <label asp-for="Name"></label>
            <input asp-for="Name" autofocus>
            <span asp-validation-for="Name"></span>
        </div>
        <div class="form-group">
            <label asp-for="Description"></label>
            <input asp-for="Description" autofocus>
            <span asp-validation-for="Description"></span>
        </div>
        <div class="form-group">

        <label asp-for="Features"></label>
        <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem;">
            <input type="text" id="newFeature" placeholder="Enter one feature" class="form-input" />
            <button type="button" id="addFeatureBtn" class="btn">Add</button>
        </div>

                <ul id="featuresList" class="service-card-features">
                    @{
                        var features = Model?.Features ?? new List<string>() { string.Empty };
                    }
                    @foreach (var f in features)
                    {
                        <li class="feature-item">
                            <input type="text" name="Features" value="@f" class="form-input feature-input" />
                            <button type="button" class="remove-feature btn" style="margin-left:.6rem;">Remove</button>
                        </li>
                    }

                </ul>
        <span asp-validation-for="Features" class="text-danger"></span>
         </div>

        <div class="form-group">
            <label asp-for="Price"></label>
            <input asp-for="Price" pattern="^\d+(\.\d{1,2})?$" title="e.g. 12.50" data-trim>
            <span asp-validation-for="Price"></span>
        </div>

        <div class="form-group">
            <label asp-for="PetType"></label>
            <select asp-for="PetType" asp-items="ViewBag.PetTypes" class="form-input">
                <option value="">-- choose pet type --</option>
            </select>
            <span asp-validation-for="PetType" class="text-danger"></span>
        </div>

            <div class="form-group">
                <label>@Localizer["Photo"]</label>
                <label class="upload" id="dropZone">
                    <small id="photoName">@previewText</small>
                    <input name="Photo" type="file" accept="image/jpeg,image/png" hidden id="photoInput">
                    <div class="image-hover">
                        <img id="photoPreview" src="@previewSrc" alt="@Localizer["Photo"]">
                    </div>
                </label>
                <br>
            <span asp-validation-for="ImageURL"></span>
            <input type="hidden" name="CroppedPhoto" id="CroppedPhoto" />
        </div>
        <!-- prompt out for image processing(hidden) -->
        <div id="cropModal" class="crop-modal">
            <div class="crop-modal-content">
                <img id="cropImage" class="crop-image" />
                <!-- Flip and Rotate Controls -->
                <div class="crop-controls">
                    <button type="button" id="rotateLeftBtn" class="btn-secondary">⟲ Rotate Left</button>
                    <button type="button" id="rotateRightBtn" class="btn-secondary">⟳ Rotate Right</button>
                    <button type="button" id="flipHorizontalBtn" class="btn-secondary">⇋ Flip Horizontal</button>
                    <button type="button" id="flipVerticalBtn" class="btn-secondary">⇵ Flip Vertical</button>
                </div>
                <div class="crop-actions">
                    <button type="button" id="cropBtn" class="btn-primary">Crop & Save</button>
                    <button type="button" id="skipCropBtn" class="btn-secondary">Skip Cropping</button>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>@Localizer["Existing Photos"]</label>
            <div id="existingImages">
                @if (Model.ImageURL != null)
                {
                    foreach (var img in Model.ImageURL)
                    {
                        <div class="existing-thumb" data-filename="@img" style="display:inline-block;margin:6px;text-align:center;">
                            <img src="@(ResolveImage(img))" style="width:100px;height:100px;object-fit:cover;border-radius:6px;display:block" />
                            <input type="hidden" name="ExistingImages" value="@img" />
                            <button type="button" class="remove-existing btn">Remove</button>
                        </div>
                    }
                }
            </div>
        </div>

        <div class="form-group">
            <label>@Localizer["Photos"]</label>
            <div style="display:flex;gap:.5rem;align-items:center;margin-bottom:.5rem;">
                <button type="button" id="selectPhotosBtn" class="btn">Select Photos</button>
                <small class="text-muted">You may select multiple images (JPEG/PNG)</small>
            </div>
            <input type="file" name="Photos" id="photosInput" accept="image/jpeg,image/png" multiple hidden>
            <div id="photosPreview" class="form-images" aria-live="polite"></div>
            <br>
            <span asp-validation-for="ImageURL"></span>
            <input type="hidden" name="CroppedPhoto" id="CroppedPhoto" />

        </div>

        <div class="form-actions">
            <button class="btn-primary">Update</button>
            <button class="btn-secondary" type="reset">Reset</button>
        </div>
    </table>
</form>

@section foot {
    <style>
        /* Ensure features line up in single column with consistent widths */
        .service-card-features {
            padding: 0;
            margin: 0 0 .5rem 0;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: .5rem;
        }

            .service-card-features .feature-item {
                display: flex;
                gap: .6rem;
                align-items: center;
                width: 100%;
            }

            /* feature text input grows to fill available space */
            .service-card-features .feature-input {
                flex: 1 1 auto;
                min-width: 0; /* allow shrinking inside flex */
                width: 100%;
                box-sizing: border-box;
            }

            /* make remove button fixed width so buttons align in a column */
            .service-card-features .remove-feature {
                flex: 0 0 84px; /* fixed column width for remove buttons */
                max-width: 84px;
                text-align: center;
                padding: inherit;
            }
    </style>
    <script>
        (function () {
            const newFeature = document.getElementById('newFeature');
            const addBtn = document.getElementById('addFeatureBtn');
            const featuresList = document.getElementById('featuresList');

            function createFeatureItem(value = '') {
                const li = document.createElement('li');
                li.className = 'feature-item';

                const input = document.createElement('input');
                input.type = 'text';
                input.name = 'Features';
                input.value = value;
                input.className = 'form-input feature-input';

                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'remove-feature btn';
                btn.style.marginLeft = '.6rem';
                btn.textContent = 'Remove';

                btn.addEventListener('click', () => {
                    li.remove();
                    ensureAtLeastOne();
                });

                li.appendChild(input);
                li.appendChild(btn);
                return li;
            }

            function ensureAtLeastOne() {
                if (!featuresList.querySelector('li')) {
                    featuresList.appendChild(createFeatureItem(''));
                }
            }

            addBtn.addEventListener('click', () => {
                const val = newFeature.value.trim();
                if (!val) return;
                featuresList.appendChild(createFeatureItem(val));
                newFeature.value = '';
                newFeature.focus();
            });

            newFeature.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBtn.click();
                }
            });

            // attach handlers to any server-rendered remove buttons
            featuresList.querySelectorAll('.remove-feature').forEach(btn => {
                btn.addEventListener('click', (ev) => {
                    const li = btn.closest('li');
                    if (li) {
                        li.remove();
                        ensureAtLeastOne();
                    }
                });
            });

            // initialize
            ensureAtLeastOne();
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // remove existing
            document.querySelectorAll('.remove-existing').forEach(btn => {
                btn.addEventListener('click', function () {
                    const parent = btn.closest('.existing-thumb');
                    if (parent) parent.remove();
                });
            });

            // new photos UI (same logic as Insert)
            const btn = document.getElementById('selectPhotosBtn');
            const input = document.getElementById('photosInput');
            const preview = document.getElementById('photosPreview');
            const dt = new DataTransfer();

            btn.addEventListener('click', () => input.click());

            function render() {
                preview.innerHTML = '';
                Array.from(dt.files).forEach((file, idx) => {
                    const el = document.createElement('div');
                    el.style = 'display:inline-block;margin:6px;text-align:center;';
                    const img = document.createElement('img');
                    img.style = 'width:100px;height:100px;object-fit:cover;border-radius:6px;display:block';
                    img.src = URL.createObjectURL(file);
                    const lbl = document.createElement('div');
                    lbl.textContent = file.name;
                    const rm = document.createElement('button');
                    rm.type = 'button';
                    rm.className = 'btn';
                    rm.textContent = 'Remove';
                    rm.addEventListener('click', () => {
                        const newDt = new DataTransfer();
                        Array.from(dt.files).forEach((f, i) => { if (i !== idx) newDt.items.add(f); });
                        while (dt.items.length) dt.items.remove(0);
                        Array.from(newDt.files).forEach(f => dt.items.add(f));
                        input.files = dt.files;
                        render();
                    });
                    el.appendChild(img);
                    el.appendChild(lbl);
                    el.appendChild(rm);
                    preview.appendChild(el);
                });
            }

            input.addEventListener('change', (e) => {
                Array.from(e.target.files).forEach(f => {
                    const exists = Array.from(dt.files).some(x => x.name === f.name && x.size === f.size);
                    if (!exists) dt.items.add(f);
                });
                input.files = dt.files;
                render();
            });
        });
    </script>
}
